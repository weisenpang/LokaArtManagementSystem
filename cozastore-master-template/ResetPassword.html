<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password - LokaArt</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f5f7f9;
    }

    .container {
      display: flex;
      background: #fff;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      overflow: hidden;
      max-width: 900px;
      width: 100%;
    }

    .illustration {
      flex: 1;
      background: #f0f4f8;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }

    .illustration img {
      width: 100%;
      max-width: 500px;
    }

    .form-container {
      flex: 1;
      padding: 50px 40px;
    }

    .form-container h2 {
      font-size: 28px;
      color: #1e293b;
      margin-bottom: 10px;
    }

    .form-container p {
      font-size: 16px;
      color: #64748b;
      margin-bottom: 30px;
    }

    .form-container input[type="password"],
    .form-container input[type="text"] {
      width: 100%;
      padding: 14px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 20px;
      background-color: #fff;
      color: #1e293b;
    }

    .form-container input[type="password"]:focus,
    .form-container input[type="text"]:focus {
      outline: none;
      border-color: #6c7ae0;
      box-shadow: 0 0 0 3px rgba(108, 122, 224, 0.1);
    }

    .password-wrapper {
      position: relative;
      margin-bottom: 20px;
    }

    .password-wrapper input {
      margin-bottom: 0;
      padding-right: 45px;
    }

    .password-wrapper .toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #64748b;
      font-size: 18px;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
    }

    .password-wrapper .toggle:hover {
      color: #6c7ae0;
    }

    .form-container button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.3s ease;
    }

    .btn-reset {
      background-color: #6c7ae0;
      color: #fff;
    }

    .btn-reset:hover:not(:disabled) {
      background-color: #424a88;
    }

    .btn-reset:disabled {
      background-color: #cbd5e1;
      cursor: not-allowed;
    }

    .btn-back {
      background-color: #f1f5f9;
      color: #1e293b;
    }

    .btn-back:hover {
      background-color: #e2e8f0;
    }

    .error {
      color: #e11d48;
      font-size: 14px;
      margin-bottom: 10px;
      display: none;
    }

    p.hint {
      font-size: 14px;
      color: #64748b;
      margin-top: -10px;
      margin-bottom: 20px;
    }

    #passwordCriteria {
      margin-bottom: 20px;
      font-size: 14px;
    }

    #passwordCriteria li {
      color: #e11d48;
      margin-bottom: 4px;
      list-style: none;
      position: relative;
      padding-left: 20px;
    }

    #passwordCriteria li.valid {
      color: #10b981;
    }

    #passwordCriteria li::before {
      content: "‚úó";
      position: absolute;
      left: 0;
      color: #e11d48;
    }

    #passwordCriteria li.valid::before {
      content: "‚úì";
      color: #10b981;
    }

    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="illustration">
      <img src="images/ResetPasswordImage.webp" alt="Reset Password Illustration" />
    </div>
    <div class="form-container">
      <h2>Set a New Password</h2>
      <p>Please enter your new password below.</p>
      <form id="resetForm">
        <div class="password-wrapper">
          <input type="password" id="newPassword" placeholder="New Password" required />
          <span class="toggle" onclick="togglePassword('newPassword', this)">üëÅ</span>
        </div>
        
        <ul id="passwordCriteria">
          <li id="lengthCheck">At least 8 characters</li>
          <li id="letterCheck">Contains letters</li>
          <li id="numberCheck">Contains numbers</li>
          <li id="specialCheck">Contains special characters (!@#$%^&*)</li>
          <li id="mixCheck">Mix of uppercase and lowercase</li>
        </ul>
        
        <div class="password-wrapper">
          <input type="password" id="confirmPassword" placeholder="Confirm Password" required />
          <span class="toggle" onclick="togglePassword('confirmPassword', this)">üëÅ</span>
        </div>
        
        <p class="error" id="errorMsg">Passwords do not match.</p>
        <button type="submit" id="updateBtn" class="btn-reset" disabled>
          <span id="spinner" class="spinner"></span>
          <span id="buttonText">Update Password</span>
        </button>
        <button type="button" class="btn-back" onclick="window.location.href='userSignIn.html'">Back to Sign In</button>
      </form>
    </div>
  </div>

  <script>
    function togglePassword(inputId, toggleElement) {
      const passwordInput = document.getElementById(inputId);
      
      if (passwordInput.getAttribute("type") === "password") {
        passwordInput.setAttribute("type", "text");
        toggleElement.textContent = "‚å£";
      } else {
        passwordInput.setAttribute("type", "password");
        toggleElement.textContent = "üëÅ";
      }
    }

    function setLoadingState(isLoading) {
      const spinner = document.getElementById("spinner");
      const buttonText = document.getElementById("buttonText");
      const updateBtn = document.getElementById("updateBtn");
      
      if (isLoading) {
        spinner.style.display = "inline-block";
        buttonText.textContent = "Updating...";
        updateBtn.disabled = true;
      } else {
        spinner.style.display = "none";
        buttonText.textContent = "Update Password";
        updateBtn.disabled = !validateForm();
      }
    }

    function showMessage(message, type = 'error') {
      const existingMessage = document.querySelector('.message');
      if (existingMessage) existingMessage.remove();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      
      const colors = {
        error: { bg: '#fef2f2', border: '#fecaca', text: '#dc2626' },
        success: { bg: '#f0f9ff', border: '#bae6fd', text: '#0369a1' }
      };
      
      const color = colors[type] || colors.error;
      
      messageDiv.style.cssText = `
        background: ${color.bg}; 
        border: 1px solid ${color.border}; 
        color: ${color.text}; 
        padding: 12px; 
        border-radius: 8px; 
        margin: 10px 0; 
        text-align: center;
        font-size: 14px;
      `;
      messageDiv.textContent = message;
      
      const form = document.getElementById("resetForm");
      form.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) messageDiv.remove();
      }, 6000);
    }

    const form = document.getElementById('resetForm');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const errorMsg = document.getElementById('errorMsg');
    const updateBtn = document.getElementById('updateBtn');
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const token = urlParams.get('token');

    // Check if we have valid email and token
    if (!email || !token) {
      document.querySelector('.form-container').innerHTML = `
        <div style="text-align: center; color: #dc2626; margin: 20px 0;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
          <h3 style="color: #dc2626; margin-bottom: 8px;">Invalid Reset Link</h3>
          <p style="color: #64748b; margin-bottom: 16px;">This password reset link is invalid or has expired.</p>
          <button onclick="window.location.href='forgotpassword.html'" style=""
            background: #6c7ae0; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            margin-top: 16px; 
            cursor: pointer;
          ">Request New Reset Link</button>
        </div>
      `;
    }

    const checks = {
      length: false,
      letter: false,
      number: false,
      special: false,
      mix: false,
      match: false
    };

    function validatePassword() {
      const password = newPassword.value;
      const confirm = confirmPassword.value;
      
      // Length check (at least 8 characters)
      checks.length = password.length >= 8;
      document.getElementById('lengthCheck').classList.toggle('valid', checks.length);
      
      // Letter check
      checks.letter = /[a-zA-Z]/.test(password);
      document.getElementById('letterCheck').classList.toggle('valid', checks.letter);
      
      // Number check
      checks.number = /\d/.test(password);
      document.getElementById('numberCheck').classList.toggle('valid', checks.number);
      
      // Special character check
      checks.special = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
      document.getElementById('specialCheck').classList.toggle('valid', checks.special);
      
      // Mix check (uppercase and lowercase)
      checks.mix = /[a-z]/.test(password) && /[A-Z]/.test(password);
      document.getElementById('mixCheck').classList.toggle('valid', checks.mix);
      
      // Match check
      checks.match = password === confirm && password.length > 0;
      
      if (confirm.length > 0) {
        errorMsg.style.display = checks.match ? 'none' : 'block';
      } else {
        errorMsg.style.display = 'none';
      }
      
      updateBtn.disabled = !validateForm();
    }

    function validateForm() {
      return Object.values(checks).every(check => check === true);
    }

    newPassword.addEventListener('input', validatePassword);
    confirmPassword.addEventListener('input', validatePassword);

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (updateBtn.disabled) return;
      
      setLoadingState(true);

      try {
        const res = await fetch('/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            password: newPassword.value,
            email: email,
            token: token
          })
        });

        const result = await res.json();

        if (res.ok && result.success) {
          // Show success message
          const successHtml = `
            <div style="text-align: center; color: #10b981; margin: 20px 0;">
              <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
              <h3 style="color: #10b981; margin-bottom: 8px;">Password Updated Successfully!</h3>
              <p style="color: #64748b; margin-bottom: 16px;">Your password has been reset. You can now sign in with your new password.</p>
              <p style="color: #64748b; font-size: 14px;">Redirecting to sign in page in <span id="countdown">3</span> seconds...</p>
            </div>
          `;
          
          document.querySelector('.form-container').innerHTML = successHtml;
          
          // Countdown redirect
          let countdown = 3;
          const countdownElement = document.getElementById("countdown");
          const interval = setInterval(() => {
            countdown--;
            if (countdownElement) countdownElement.textContent = countdown;
            if (countdown <= 0) {
              clearInterval(interval);
              window.location.href = "userSignIn.html";
            }
          }, 1000);
          
        } else {
          setLoadingState(false);
          showMessage("‚ùå " + (result.error || "Failed to update password"), 'error');
        }
      } catch (err) {
        setLoadingState(false);
        console.error("Reset password error:", err);
        showMessage("üåê Connection error. Please check your internet and try again.", 'error');
      }
    });
  </script>
</body>
</html>